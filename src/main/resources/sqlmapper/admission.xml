<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="kr.co.hconnect.sqlmapper">

	<!-- Pagination Total RowCount 조회 -->
	<select id="selectFoundRowsByAdmission" resultType="Integer">
        SELECT FOUND_ROWS()
    </select>

	<!-- 로그인ID 기준 격리/입소내역(내원중) 리스트 조회 -->
	<select id="selectActiveAdmissionListByLoginId" parameterType="String" resultType="kr.co.hconnect.vo.AdmissionVO">
	<![CDATA[
		SELECT A.ADMISSION_ID             -- 격리/입소내역ID
		     , A.PATIENT_ID               -- 환자ID
		     , A.ADMISSION_DATE           -- 시작일
		     , A.DSCHGE_SCHDLD_DATE       -- 종료예정일
		     , A.DSCHGE_DATE              -- 종료일
		     , A.QANTN_DIV                -- 격리/입소구분 - CD004
		     , A.PERSON_CHARGE            -- 담당자
		     , A.CENTER_ID                -- 센터ID
		     , A.ROOM                     -- 호실
		     , A.DEL_YN                   -- 삭제여부
		     , A.REG_ID                   -- 등록자ID
		     , A.REG_DT                   -- 등록일시
		     , A.UPD_ID                   -- 수정자ID
		     , A.UPD_DT                   -- 수정일시
		  FROM ADMISSION A
		       INNER JOIN PATIENT B  ON A.PATIENT_ID = B.PATIENT_ID
		 WHERE A.ADMISSION_DATE <= NOW()
		   AND A.DSCHGE_DATE IS NULL
		   AND A.DEL_YN = 'N'
		   AND B.LOGIN_ID = #{loginId}
	]]>
	</select>

	<!-- 생활치료센터 입소자 리스트 조회 - kr.co.hconnect.sqlmapper.selectAdmissionListByCenter -->
	<select id="selectAdmissionListByCenter"
			parameterType="kr.co.hconnect.vo.AdmissionListSearchByCenterVO"
			resultType="kr.co.hconnect.vo.AdmissionByCenterVO">
	<![CDATA[
		-- 입소자내역 리스트 조회
		-- selectAdmissionList
		SELECT SQL_CALC_FOUND_ROWS
		       A.ADMISSION_ID 					              -- 입소내역ID
			 , A.CENTER_ID                                    -- 센터ID
			 , TC.CENTER_NM                                   -- 센터명
			 , P.PATIENT_ID                                   -- 환자ID
			 , P.PATIENT_NM                                   -- 환자명
			 , A.ADMISSION_DATE                               -- 시작일
			 , A.ROOM                                         -- 호실
			 , ROOM.DETAIL_CD_NM            AS ROOM_NM        -- 호실명
			 , A.QANTN_DIV                                    -- 격리/입소 구분(CD004)
			 , TIMESTAMPDIFF(DAY, A.ADMISSION_DATE, NOW())
			                                AS QANTN_DAY      -- 격리일수
			 , CASE WHEN A.DSCHGE_DATE IS NULL
                         THEN '1'
                    ELSE      '2'
               END                          AS QANTN_STATUS   -- 입소/격리 상태
		  FROM ADMISSION A
			   INNER JOIN PATIENT 			P      ON A.PATIENT_ID = P.PATIENT_ID
			   INNER JOIN TREATMENT_CENTER 	TC     ON A.CENTER_ID  = TC.CENTER_ID
			   INNER JOIN COM_CD_DETAIL 	ROOM   ON ROOM.COM_CD    = 'CD005'
			                                      AND ROOM.DETAIL_CD = A.ROOM
										          AND ROOM.PROPERTY1 = TC.HOSPITAL_CD
         WHERE A.CENTER_ID = #{centerId}	-- 센터ID
		   AND A.QANTN_DIV = '2'            -- 생활치료센터 입소자 구분
		   AND A.DEL_YN = 'N'
	]]>

		<if test="@org.apache.commons.lang3.StringUtils@isNotEmpty(patientId)">
		   AND P.PATIENT_ID = #{patientId}
		</if>
		<if test="@org.apache.commons.lang3.StringUtils@isNotEmpty(patientNm)">
		   AND P.PATIENT_NM LIKE CONCAT('%', #{patientNm},'%')
		</if>

		ORDER
		   BY
		<choose>
			<when test="@org.apache.commons.lang3.StringUtils@isNotEmpty(orderBy)">
				${orderBy} ${orderDir}
			</when>
			<otherwise>
				A.ADMISSION_DATE DESC
			</otherwise>
		</choose>

		LIMIT #{recordCountPerPage}
	    OFFSET #{offsetCount}

	</select>
	
	<!-- 입소내역 정보 조회 - kr.co.hconnect.sqlmapper.selectAdmissionInfo -->
	<select id="selectAdmissionInfo" parameterType="String" resultType="kr.co.hconnect.vo.AdmissionInfoVO">
	<![CDATA[
		-- 입소내역 정보 조회
		-- selectAdmissionInfo
		SELECT A.ADMISSION_ID                          -- 입소내역ID
		     , P.PATIENT_ID                            -- 환자ID
		     , P.PATIENT_NM                            -- 환자명
		     , P.BIRTH_DATE                            -- 생년월일
		     , P.SEX                                   -- 성별
		     , P.CELL_PHONE                            -- 휴대폰
		     , A.PERSON_CHARGE                         -- 담당자
		     , A.ADMISSION_DATE                        -- 시작일
		     , A.DSCHGE_SCHDLD_DATE                    -- 종료예정일
		     , A.DSCHGE_DATE                           -- 종료일
		     , A.CENTER_ID                             -- 센터ID
		     , A.ROOM                                  -- 호실(위치)
		     , A.QANTN_DIV                             -- 격리/입소 구분
		     , A.DEL_YN                                -- 삭제 여부
		  FROM ADMISSION A
		       INNER JOIN PATIENT    P  ON A.PATIENT_ID = P.PATIENT_ID
		 WHERE A.ADMISSION_ID = #{admissionId}
	]]>
	</select>

    <!-- 입소내역 생성 -->
	<insert id="insertAdmission" parameterType="kr.co.hconnect.vo.AdmissionVO">
	<![CDATA[
		-- 입소내역 생성
		-- insertAdmission
		INSERT
		  INTO ADMISSION
		     ( ADMISSION_ID
		     , PATIENT_ID
		     , ADMISSION_DATE
		     , DSCHGE_SCHDLD_DATE
		     , QANTN_DIV
		     , PERSON_CHARGE
		     , CENTER_ID
		     , ROOM
		     , REG_ID
		     , UPD_ID
		     )
		VALUES
		     ( #{admissionId}
		     , #{patientId}
		     , #{admissionDate}
		     , #{dschgeSchdldDate}
		     , #{qantnDiv}
		     , #{personCharge}
		     , #{centerId}
		     , #{room}
		     , #{regId}
		     , #{regId}
		     )
	]]>	
	</insert>
	
    <!-- 입소내역 수정 -->
	<update id="updateAdmission" parameterType="kr.co.hconnect.vo.AdmissionVO">
	<![CDATA[
		-- 입소내역 수정
		-- updateAdmission
		UPDATE ADMISSION 
		   SET ADMISSION_DATE     = #{admissionDate}
		     , DSCHGE_SCHDLD_DATE = #{dschgeSchdldDate}
		     , PERSON_CHARGE      = #{personCharge}
		     , CENTER_ID          = #{centerId}
		     , ROOM               = #{room}
		     , UPD_ID             = #{updId}
		     , UPD_DT             = NOW()
		 WHERE ADMISSION_ID = #{admissionId}
	]]>			
	</update>
	
	<!-- 퇴소처리 -->
	<update id="updateAdmissionDischarge" parameterType="kr.co.hconnect.vo.AdmissionVO">
	<![CDATA[
		-- 퇴소처리
		-- updateAdmissionDischarge
		UPDATE ADMISSION 
		   SET DISCHARGE_DATE = #{dischargeDate} 
		   	 , UPD_ID         = #{updId}
		     , UPD_DT         = current_timestamp()
		 WHERE ADMISSION_ID = #{admissionId}
	]]>
	</update>

</mapper>
