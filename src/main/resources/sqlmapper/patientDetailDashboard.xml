<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="kr.co.hconnect.sqlmapper">

    <!-- 환자 상세 대시보드 상단 정보 조회 - kr.co.hconnect.sqlmapper.selectPatientDetailDashboardHeaderBase -->
    <select id="selectPatientDetailDashboardHeaderBase"
            parameterType="String"
            resultType="kr.co.hconnect.vo.PatientDetailDashboardHeaderBaseVO">
        SELECT A.ADMISSION_ID                                         -- 격리/입소내역ID
             , P.PATIENT_ID                                           -- 환자ID
             , P.PATIENT_NM                                           -- 환자명
             , TRUNCATE((TO_DAYS(NOW()) - TO_DAYS(P.BIRTH_DATE)) / 365, 0)
                                    AS AGE                            -- 나이-만
             , P.BIRTH_DATE                                           -- 생년월일
             , P.SEX                                                  -- 성별
             , CASE WHEN IFNULL(CCDS.PROPERTY2, '') = ''
                         THEN P.SEX
                    ELSE      CCDS.PROPERTY2
               END                  AS SEX_NM                         -- 성별명칭
             , P.CELL_PHONE                                           -- 연락처
             , A.QANTN_DIV                                            -- 격리/입소 구분
             , CASE WHEN A.QANTN_DIV = '2'
                         THEN A.CENTER_ID
                    ELSE      ''
               END                  AS CENTER_ID                      -- 센터ID
             , CASE WHEN A.QANTN_DIV = '2'
                         THEN TC.CENTER_NM
                    ELSE      ''
               END                  AS CENTER_NM                      -- 센터명
             , CASE WHEN A.QANTN_DIV = '2'
                         THEN A.ROOM
                    ELSE      ''
               END                  AS ROOM                           -- 호실(위치)
             , CASE WHEN A.QANTN_DIV = '2'
                         THEN CCDR.DETAIL_CD_NM
                    ELSE      ''
               END                  AS ROOM_NM                        -- 호실(위치) 명
             , A.ADMISSION_DATE                                       -- 시작일
             , A.DSCHGE_SCHDLD_DATE                                   -- 종료예정일
             , A.DSCHGE_DATE                                          -- 종료일
             , CASE WHEN A.DSCHGE_DATE IS NULL
                         THEN 'N'
                    ELSE      'Y'
               END                  AS DSCHGE_YN                      -- 퇴소/해제 여부
          FROM ADMISSION A
               INNER JOIN PATIENT          P     ON A.PATIENT_ID   = P.PATIENT_ID
               LEFT JOIN TREATMENT_CENTER  TC    ON A.CENTER_ID = TC.CENTER_ID
               INNER JOIN COM_CD_DETAIL    CCDS  ON CCDS.COM_CD    = 'CD003'
                                                AND CCDS.DETAIL_CD = P.SEX
               LEFT JOIN COM_CD_DETAIL     CCDR  ON CCDR.COM_CD    = 'CD005'
                                                AND CCDR.DETAIL_CD = A.ROOM
                                                AND CCDR.PROPERTY1 = A.CENTER_ID
         WHERE A.ADMISSION_ID = #{admissionId}
           AND A.DEL_YN = 'N'
    </select>

    <!-- 환자 마지막 신체계측, 수면, 예측결과 조회 - kr.co.hconnect.sqlmapper.selectPatientDetailDashboardRecentResult -->
    <select id="selectPatientDetailDashboardRecentResult"
            parameterType="String"
            resultType="kr.co.hconnect.vo.PatientDetailDashboardRecentResultVO">
    <![CDATA[
        WITH TOTAL_SLEEP AS (
            /* 조회일 기준 전날 오후 09시 ~ 당일 오전 06시까지 수면 시간 계산 */
            SELECT #{admissionId} AS ADMISSION_ID
                , TRUNCATE(SUM(
                                CASE WHEN X.RESULT_START_DATE = X.RESULT_END_DATE
                                          THEN
                                               CASE WHEN X.RESULT_START_DATE = DATE (DATE_ADD(NOW(), INTERVAL -1 DAY))
                                                         THEN TIMESTAMPDIFF(MINUTE, TIMESTAMP(X.RESULT_START_DATE, GREATEST(X.RESULT_START_TIME, TIME('060000'))), TIMESTAMP(X.RESULT_END_DATE, X.RESULT_END_TIME))
                                                    ELSE      TIMESTAMPDIFF(MINUTE, TIMESTAMP(X.RESULT_START_DATE, X.RESULT_START_TIME), TIMESTAMP(X.RESULT_END_DATE, LEAST(X.RESULT_END_TIME, TIME('210000'))))
                                               END
                                     ELSE TIMESTAMPDIFF(MINUTE, TIMESTAMP(X.RESULT_START_DATE, GREATEST(X.RESULT_START_TIME, TIME('060000'))), TIMESTAMP(X.RESULT_END_DATE, LEAST(X.RESULT_END_TIME, TIME('210000'))))
                                END
                           ) / 60
                  , 0)  AS SLEEP_RESULT
             FROM RESULT_SLEEP X
            WHERE X.ADMISSION_ID = #{admissionId}
              AND X.SLEEP_TYPE IN ('0', '1') -- 깊은잠, 얕은잠
              AND (   X.RESULT_END_DATE = DATE (DATE_ADD(NOW(), INTERVAL -1 DAY)) AND X.RESULT_END_TIME > TIME ('210000')
                   OR X.RESULT_END_DATE = DATE (NOW()) AND X.RESULT_END_TIME < TIME ('060000'))
        )
        SELECT A.ADMISSION_ID
             -- 혈압
             , RDSBP.RESULT                                 AS SBP_RESULT
             , RDDBP.RESULT                                 AS DBP_RESULT
             , CASE WHEN RDSBP.RESULT > IBP.REF_FROM
                         THEN 'H'
                    ELSE      ''
               END                                          AS SBP_RISK_GB
             , CASE WHEN RDDBP.RESULT < IBP.REF_TO
                         THEN 'L'
                    ELSE      ''
               END                                          AS DBP_RISK_GB
             , TIMESTAMP(RBP.RESULT_DATE, RBP.RESULT_TIME)  AS BP_RESULT_DT
             , IBP.UNIT                                     AS BP_UNIT
             -- 심박수
             , RDPR.RESULT                                  AS PR_RESULT
             , CASE WHEN RDPR.RESULT < IPR.REF_FROM
                         THEN 'L'
                    WHEN RDPR.RESULT > IPR.REF_TO
                         THEN 'H'
                    ELSE      ''
               END                                          AS PR_RISK_GB
             , TIMESTAMP(RPR.RESULT_DATE, RPR.RESULT_TIME)  AS PR_RESULT_DT
             , IPR.UNIT                                     AS PR_UNIT
             -- 체온
             , RDBT.RESULT                                  AS BT_RESULT
             , CASE WHEN RDBT.RESULT < IBT.REF_FROM
                         THEN 'L'
                    WHEN RDBT.RESULT > IBT.REF_TO
                         THEN 'H'
                    ELSE      ''
               END                                          AS BT_RISK_GB
             , TIMESTAMP(RBT.RESULT_DATE, RBT.RESULT_TIME)  AS BT_RESULT_DT
             , IBT.UNIT                                     AS BT_UNIT
             -- 걸음수
             , RDST1.RESULT                                 AS ST1_RESULT
             , RDST2.RESULT                                 AS ST2_RESULT
             , ''                                           AS ST1_RISK_GB
             , ''                                           AS ST2_RISK_GB
             , TIMESTAMP(RST.RESULT_DATE, RST.RESULT_TIME)  AS ST_RESULT_DT
             , IST.UNIT                                     AS ST_UNIT
             -- 호흡(데이터 입력 가능 여부 미정)
             , RDRP.RESULT                                  AS RR_RESULT
             , CASE WHEN RDRP.RESULT < IRP.REF_FROM
                         THEN 'L'
                    WHEN RDSP.RESULT > IRP.REF_TO
                         THEN 'H'
                    ELSE      ''
               END                                          AS RR_RISK_GB
             , TIMESTAMP(RRP.RESULT_DATE, RRP.RESULT_TIME)  AS RR_RESULT_DT
             , IRP.UNIT                                     AS RR_UNIT
             -- 산소포화도
             , RDSP.RESULT                                  AS SP_RESULT
             , CASE WHEN RDSP.RESULT < ISP.REF_FROM
                         THEN 'L'
                    WHEN RDSP.RESULT > ISP.REF_TO
                         THEN 'H'
                    ELSE      ''
               END                                          AS SP_RISK_GB
             , TIMESTAMP(RSP.RESULT_DATE, RSP.RESULT_TIME)  AS SP_RESULT_DT
             , ISP.UNIT                                     AS SP_UNIT

             , SLEEP.SLEEP_RESULT                           AS SLEEP_RESULT                    -- 총 수면시간
             , CASE WHEN SLEEP_RESULT IS NULL
                         THEN NULL
                    ELSE      DATE (NOW())
               END                                          AS SLEEP_DT                        -- 수면 측정일
             , '시간'                                        AS SLEEP_UNIT                      -- 수면 단위
             , NULL                                         AS RESPIRATORY_RISK_RESULT         -- 호흡기계 위험도
             , NULL                                         AS RESPIRATORY_RISK_RESULT_DT      -- 호흡기계 위험도 측정일시
             , NULL                                         AS RESPIRATORY_RISK_UNIT           -- 호흡기계 위험도 단위
             , NULL                                         AS MENTAL_RISK_RESULT              -- 정신건강 위험도
             , NULL                                         AS MENTAL_RISK_RESULT_DT           -- 정신건강 위험도 측정일시
             , NULL                                         AS MENTAL_RISK_UNIT                -- 정신건강 위험도 단위
          FROM ADMISSION A
               /* 혈압 */
               INNER JOIN ITEM            IBP     ON IBP.ITEM_ID = 'I0005'
               LEFT JOIN RESULT           RBP     ON RBP.RESULT_SEQ = (SELECT X.RESULT_SEQ
                                                                         FROM RESULT X
                                                                        WHERE X.ADMISSION_ID = A.ADMISSION_ID
                                                                          AND X.ITEM_ID = IBP.ITEM_ID
                                                                        ORDER BY X.RESULT_DATE DESC, X.RESULT_TIME DESC
                                                                        LIMIT 1)
               LEFT JOIN RESULT_DETAIL    RDSBP   ON RDSBP.RESULT_SEQ = RBP.RESULT_SEQ
                                                 AND RDSBP.RESULT_TYPE = '03'
               LEFT JOIN RESULT_DETAIL    RDDBP   ON RDDBP.RESULT_SEQ = RBP.RESULT_SEQ
                                                 AND RDDBP.RESULT_TYPE = '02'
               /* 심박수 */
               INNER JOIN ITEM            IPR     ON IPR.ITEM_ID = 'I0002'
               LEFT JOIN RESULT           RPR     ON RPR.RESULT_SEQ = (SELECT X.RESULT_SEQ
                                                                         FROM RESULT X
                                                                        WHERE X.ADMISSION_ID = A.ADMISSION_ID
                                                                          AND X.ITEM_ID = IPR.ITEM_ID
                                                                        ORDER BY X.RESULT_DATE DESC, X.RESULT_TIME DESC
                                                                        LIMIT 1)
               LEFT JOIN RESULT_DETAIL    RDPR    ON RDPR.RESULT_SEQ = RPR.RESULT_SEQ
               /* 체온 */
               INNER JOIN ITEM            IBT     ON IBT.ITEM_ID = 'I0001'
               LEFT JOIN RESULT           RBT     ON RBT.RESULT_SEQ = (SELECT X.RESULT_SEQ
                                                                         FROM RESULT X
                                                                        WHERE X.ADMISSION_ID = A.ADMISSION_ID
                                                                          AND X.ITEM_ID = IBT.ITEM_ID
                                                                        ORDER BY X.RESULT_DATE DESC, X.RESULT_TIME DESC
                                                                        LIMIT 1)
               LEFT JOIN RESULT_DETAIL     RDBT    ON RDBT.RESULT_SEQ = RBT.RESULT_SEQ
               /* 걸음수 */
               INNER JOIN ITEM             IST     ON IST.ITEM_ID = 'I0004'
               LEFT JOIN RESULT            RST     ON RST.RESULT_SEQ = (SELECT X.RESULT_SEQ
                                                                          FROM RESULT X
                                                                         WHERE X.ADMISSION_ID = A.ADMISSION_ID
                                                                           AND X.ITEM_ID = IST.ITEM_ID
                                                                         ORDER BY X.RESULT_DATE DESC, X.RESULT_TIME DESC
                                                                         LIMIT 1)
               LEFT JOIN RESULT_DETAIL     RDST1   ON RDST1.RESULT_SEQ = RST.RESULT_SEQ
                                                  AND RDST1.RESULT_TYPE = '04'
               LEFT JOIN RESULT_DETAIL     RDST2   ON RDST2.RESULT_SEQ = RST.RESULT_SEQ
                                                  AND RDST2.RESULT_TYPE = '05'
               /* 산소포화도 */
               LEFT JOIN ITEM              ISP     ON ISP.ITEM_ID = 'I0003'
               LEFT JOIN RESULT            RSP     ON RSP.RESULT_SEQ = (SELECT X.RESULT_SEQ
                                                                         FROM RESULT X
                                                                        WHERE X.ADMISSION_ID = A.ADMISSION_ID
                                                                          AND X.ITEM_ID = ISP.ITEM_ID
                                                                        ORDER BY X.RESULT_DATE DESC, X.RESULT_TIME DESC
                                                                        LIMIT 1)
               LEFT JOIN RESULT_DETAIL     RDSP    ON RDSP.RESULT_SEQ = RSP.RESULT_SEQ
               /* 총 수면시간 */
               LEFT JOIN TOTAL_SLEEP       SLEEP   ON SLEEP.ADMISSION_ID = A.ADMISSION_ID
               /* 호흡수 */
               LEFT JOIN ITEM              IRP     ON IRP.ITEM_ID = 'I0006'
               LEFT JOIN RESULT            RRP     ON RRP.RESULT_SEQ = (SELECT X.RESULT_SEQ
                                                                         FROM RESULT X
                                                                        WHERE X.ADMISSION_ID = A.ADMISSION_ID
                                                                          AND X.ITEM_ID = ISP.ITEM_ID
                                                                        ORDER BY X.RESULT_DATE DESC, X.RESULT_TIME DESC
                                                                        LIMIT 1)
               LEFT JOIN RESULT_DETAIL     RDRP    ON RDRP.RESULT_SEQ = RRP.RESULT_SEQ

         WHERE A.ADMISSION_ID = #{admissionId}
    ]]>
    </select>

    <!-- 환자 차트 표현용 데이터 조회 - kr.co.hconnect.sqlmapper.selectPatientVitalDataVO -->
    <select id="selectPatientVitalChartData"
            parameterType="kr.co.hconnect.vo.PatientVitalChartDataSearchVO"
            resultType="kr.co.hconnect.vo.PatientVitalChartDataVO">
    <![CDATA[
        WITH RECURSIVE TAB AS (
             SELECT TIMESTAMP(DATE(#{searchDt}), TIME('000000')) AS START_DT
                  , TIMESTAMP(DATE(#{searchDt}), TIME('001459')) AS END_DT
              UNION ALL
             SELECT DATE_ADD(START_DT, INTERVAL 15 MINUTE )
                  , DATE_ADD(END_DT, INTERVAL 15 MINUTE )
               FROM TAB
              WHERE END_DT < TIMESTAMP (DATE(#{searchDt}), TIME (IF(IFNULL(#{time}, '') = '', '235959', #{time})))
        )
        SELECT X.START_DT                                                                         AS RESULT_DT          -- 측정일시
             , MAX(IF(X.ITEM_ID = 'I0001' AND X.LV = 1, X.RESULT, NULL))                          AS BT                 -- 체온
             , MAX(IF(X.ITEM_ID = 'I0002' AND X.LV = 1, X.RESULT, NULL))                          AS PR                 -- 심박수
             , MAX(IF(X.ITEM_ID = 'I0003' AND X.LV = 1, X.RESULT, NULL))                          AS SPO2               -- 산소포솨도
             , NULL                                                                               AS RR                 -- 호흡수(현재 측정 데이터 없음)
             , MAX(IF(X.ITEM_ID = 'I0005' AND X.RESULT_TYPE = '03' AND X.LV = 1, X.RESULT, NULL)) AS SBP                -- 혈압-SBP
             , MAX(IF(X.ITEM_ID = 'I0005' AND X.RESULT_TYPE = '02' AND X.LV = 1, X.RESULT, NULL)) AS DBP                -- 혈압-DBP
          FROM (SELECT T.START_DT
                     /* 15분간의 기준 중 최근 측정 내역 조회를 위한 조건 */
                     , RANK() OVER(PARTITION BY T.START_DT, R.ITEM_ID ORDER BY R.RESULT_TIME DESC) AS LV
                     , I.ITEM_ID
                     , R.RESULT_TIME
                     , RD.RESULT
                     , RD.RESULT_TYPE
                  FROM TAB T
                       LEFT JOIN  RESULT        R    ON R.ADMISSION_ID = #{admissionId}
                                                    AND R.ITEM_ID IN ('I0001','I0002','I0003','I0005')
                                                    AND R.RESULT_DATE BETWEEN DATE (T.START_DT) AND DATE (T.START_DT)
                                                    AND R.RESULT_TIME BETWEEN TIME (T.START_DT) AND TIME (T.END_DT)
                       LEFT JOIN ITEM          I    ON R.ITEM_ID = I.ITEM_ID
                       LEFT JOIN RESULT_DETAIL RD   ON R.RESULT_SEQ = RD.RESULT_SEQ
               ) X
        GROUP BY X.START_DT
        ORDER BY X.START_DT
        ;
    ]]>
    </select>

<!--	&lt;!&ndash; 환자 상세 대쉬보드 입소 상세 정보 조회 &ndash;&gt;-->
<!--	<select id="selectPatientDetailDashboardPatientInfo" parameterType="String" resultType="kr.co.hconnect.vo.PatientDetailDashboardPatientInfoVO">-->
<!--	<![CDATA[-->
<!--	    &#45;&#45; 환자 상세 대쉬보드 입소 상세 정보 조회-->
<!--	    &#45;&#45; selectPatientDetailDashboardPatientInfo-->
<!--	    /* TODO::V/S ITEM_CD 확정 후 쿼리 수정 필요 */-->
<!--        WITH TAB AS (-->
<!--            SELECT X.ITEM_ID-->
<!--                , MAX(X.RESULT_SEQ) AS RESULT_SEQ-->
<!--            FROM RESULT X-->
<!--            WHERE X.ADMISSION_ID = #{admissionId}-->
<!--            GROUP BY ITEM_ID)-->
<!--        SELECT A.ADMISSION_ID                                              AS ADMISSION_ID-->
<!--             , A.ADMISSION_DATE                                            AS ADMIT_DATE-->
<!--             , TC.CENTER_NM                                                AS CENTER_NM-->
<!--             , B.PATIENT_NM                                                AS NAME-->
<!--             , ROOM.DETAIL_CD_NM                                           AS LOCATION_NM-->
<!--             , B.PATIENT_ID                                                AS PATIENT_ID-->
<!--             , B.BIRTH_DATE                                                AS BIRTH_DATE-->
<!--             , B.CELL_PHONE                                                AS CONTACT-->
<!--             , SEX.DETAIL_CD_NM                                            AS SEX_NM-->
<!--             , TRUNCATE((TO_DAYS(NOW()) - TO_DAYS(B.BIRTH_DATE)) / 365, 0) AS AGE-->

<!--            /* 혈압 */-->
<!--             , IBP.ITEM_NM                                                 AS BP_NM-->
<!--             , IBP.UNIT                                                    AS BP_UNIT-->
<!--             , CONCAT(RDSBP.RESULT, '/', RDDBP.RESULT)                     AS BP-->
<!--             , 'N'                                                         AS BP_RISK_YN-->
<!--             , RBP.RESULT_DATE                                             AS BP_RESULT_DT-->
<!--            /* 맥박 */-->
<!--             , IPR.ITEM_NM                                                 AS PR_NM-->
<!--             , IPR.UNIT                                                    AS PR_UNIT-->
<!--             , RDPR.RESULT                                                 AS PR-->
<!--             , 'N'                                                         AS PR_RISK_YN-->
<!--             , RPR.RESULT_DATE                                             AS PR_RESULT_DT-->
<!--            /* 체온 */-->
<!--             , IBT.ITEM_NM                                                 AS BT_NM-->
<!--             , IBT.UNIT                                                    AS BT_UNIT-->
<!--             , RDBT.RESULT                                                 AS BT-->
<!--             , 'N'                                                         AS BT_RISK_YN-->
<!--             , RBT.RESULT_DATE                                             AS BT_RESULT_DT-->
<!--            /*     , CASE WHEN CONCAT('', (RBT.RESULT * 1)) = RBT.RESULT-->
<!--                             THEN-->
<!--                                  CASE WHEN RBT.RESULT > IBT.REF_FROM-->
<!--                                            THEN 'H'-->
<!--                                       WHEN RBT.RESULT < IBT.REF_TO-->
<!--                                            THEN 'L'-->
<!--                                       ELSE      ''-->
<!--                                  END-->
<!--                        ELSE      ''-->
<!--                   END                 AS BT_RIST_GB */-->
<!--            /* 호흡 */-->
<!--             , IRR.ITEM_NM                                                 AS RR_NM-->
<!--             , IRR.UNIT                                                    AS RR_UNIT-->
<!--             , RDRR1.RESULT                                                AS RR-->
<!--             , RDRR2.RESULT                                                AS RR2-->
<!--             , 'N'                                                         AS RR_RISK_YN-->
<!--             , RRR.RESULT_DATE                                             AS RR_RESULT_DT-->
<!--            /* 산소포화도 */-->
<!--             , ISP.ITEM_NM                                                 AS SPO2_NM-->
<!--             , ISP.UNIT                                                    AS SPO2_UNIT-->
<!--             , RDSP.RESULT                                                 AS SPO2-->
<!--             , 'N'                                                         AS SPO2_RISK_YN-->
<!--             , RSP.RESULT_DATE                                             AS SPO2_RESULT_DT-->
<!--        FROM ADMISSION A-->
<!--                 INNER JOIN PATIENT B ON A.PATIENT_ID = B.PATIENT_ID-->
<!--                 INNER JOIN TREATMENT_CENTER TC on A.CENTER_ID = tc.CENTER_ID-->
<!--                 LEFT JOIN COM_CD_DETAIL SEX ON SEX.COM_CD = 'CD003' AND B.SEX = SEX.DETAIL_CD-->
<!--                 LEFT JOIN COM_CD_DETAIL ROOM ON ROOM.COM_CD = 'CD005' AND A.ROOM = ROOM.DETAIL_CD-->
<!--            /* 혈압 */-->
<!--                 INNER JOIN ITEM IBP ON IBP.ITEM_ID = 'I0005'-->
<!--                 LEFT JOIN RESULT RBP ON RBP.RESULT_SEQ = (SELECT X.RESULT_SEQ FROM TAB X WHERE X.ITEM_ID = IBP.ITEM_ID)-->
<!--                 LEFT JOIN RESULT_DETAIL RDSBP ON RDSBP.RESULT_SEQ = RBP.RESULT_SEQ-->
<!--            AND RDSBP.RESULT_TYPE = '03'-->
<!--                 LEFT JOIN RESULT_DETAIL RDDBP ON RDDBP.RESULT_SEQ = RBP.RESULT_SEQ-->
<!--            AND RDDBP.RESULT_TYPE = '02'-->
<!--            /* 심박수-맥박 */-->
<!--                 INNER JOIN ITEM IPR ON IPR.ITEM_ID = 'I0002'-->
<!--                 LEFT JOIN RESULT RPR ON RPR.RESULT_SEQ = (SELECT X.RESULT_SEQ FROM TAB X WHERE X.ITEM_ID = IPR.ITEM_ID)-->
<!--                 LEFT JOIN RESULT_DETAIL RDPR ON RDPR.RESULT_SEQ = RPR.RESULT_SEQ-->
<!--            /* 체온 */-->
<!--                 INNER JOIN ITEM IBT ON IBT.ITEM_ID = 'I0001'-->
<!--                 LEFT JOIN RESULT RBT ON RBT.RESULT_SEQ = (SELECT X.RESULT_SEQ FROM TAB X WHERE X.ITEM_ID = IBT.ITEM_ID)-->
<!--                 LEFT JOIN RESULT_DETAIL RDBT ON RDBT.RESULT_SEQ = RBT.RESULT_SEQ-->
<!--            /* 걸음수-호흡 */-->
<!--                 INNER JOIN ITEM IRR ON IRR.ITEM_ID = 'I0004'-->
<!--                 LEFT JOIN RESULT RRR ON RRR.RESULT_SEQ = (SELECT X.RESULT_SEQ FROM TAB X WHERE X.ITEM_ID = IRR.ITEM_ID)-->
<!--                 LEFT JOIN RESULT_DETAIL RDRR1 ON RDRR1.RESULT_SEQ = RRR.RESULT_SEQ-->
<!--            AND RDRR1.RESULT_TYPE = '04'-->
<!--                 LEFT JOIN RESULT_DETAIL RDRR2 ON RDRR2.RESULT_SEQ = RRR.RESULT_SEQ-->
<!--            AND RDRR2.RESULT_TYPE = '05'-->
<!--            /* 산소포화도 */-->
<!--                 LEFT JOIN ITEM ISP ON ISP.ITEM_ID = 'I0003'-->
<!--                 LEFT JOIN RESULT RSP ON RSP.RESULT_SEQ = (SELECT X.RESULT_SEQ FROM TAB X WHERE X.ITEM_ID = ISP.ITEM_ID)-->
<!--                 LEFT JOIN RESULT_DETAIL RDSP ON RDSP.RESULT_SEQ = RSP.RESULT_SEQ-->
<!--        WHERE A.ADMISSION_ID = #{admissionId}-->

<!--	]]>-->
<!--	</select>-->

<!--	&lt;!&ndash; 환자 상세 대쉬보드 측정결과 데이터 조회 &ndash;&gt;-->
<!--	<select id="selectPatientDetailDashboardResultList"-->
<!--			parameterType="kr.co.hconnect.vo.PatientDetailDashboardResultSearchVO"-->
<!--			resultType="kr.co.hconnect.vo.PatientDetailDashboardResultVO">-->
<!--    <![CDATA[-->
<!--        WITH TAB_RESULT AS (-->
<!--            SELECT R.RESULT_SEQ-->
<!--                 , TIMESTAMP(R.RESULT_DATE, R.RESULT_TIME) AS RESULT_DT-->
<!--                 , R.ITEM_ID-->
<!--                 /* 혈압 */-->
<!--                 , IBP.ITEM_NM                             AS BP_ITEM-->
<!--                 , RSBP.RESULT                             AS SBP-->
<!--                 , RDBP.RESULT                             AS DBP-->
<!--                 , CASE WHEN !(RSBP.RESULT > IBP.REF_FROM OR RDBP.RESULT < IBP.REF_TO)-->
<!--                             THEN 'Y'-->
<!--                        ELSE 'N' END-->
<!--                                                           AS BP_RISK_YN-->
<!--                 /* 심박수-맥박 */-->
<!--                 , IPR.ITEM_NM                             AS PR_TIEM-->
<!--                 , RPR.RESULT                              AS PR-->
<!--                 , CASE WHEN !(RPR.RESULT BETWEEN IPR.REF_FROM AND IPR.REF_TO)-->
<!--                             THEN 'Y'-->
<!--                        ELSE 'N' END                       AS PR_RISK_YN-->
<!--                 /* 체온 */-->
<!--                 , IBT.ITEM_NM                             AS BT_ITEM-->
<!--                 , RBT.RESULT                              AS BT-->
<!--                 , CASE WHEN !(RBT.RESULT BETWEEN IBT.REF_FROM AND IBT.REF_TO)-->
<!--                             THEN 'Y'-->
<!--                        ELSE 'N' END                       AS BT_RISK_YN-->
<!--                 /* 걸읍수-호흡 */-->
<!--                 , IRR.ITEM_NM                             AS RR_ITEM-->
<!--                 , RRR1.RESULT                             AS RR1-->
<!--                 , RRR2.RESULT                             AS RR2-->
<!--                 , CASE WHEN !(RRR1.RESULT BETWEEN IRR.REF_FROM AND IRR.REF_TO)-->
<!--                             THEN 'Y'-->
<!--                        ELSE 'N' END                       AS RR_RISK_YN-->
<!--                 /* 산소포화도 */-->
<!--                 , ISP.ITEM_NM                             AS SPO2_ITEM-->
<!--                 , RSP.RESULT                              AS SPO2-->
<!--                 , CASE WHEN !(RSP.RESULT BETWEEN ISP.REF_FROM AND ISP.REF_TO)-->
<!--                             THEN 'Y'-->
<!--                        ELSE 'N' END                       AS SPO2_RISK_YN-->
<!--              FROM RESULT R-->
<!--                   /* 혈압 */-->
<!--                   INNER JOIN ITEM         IBP   ON IBP.ITEM_ID = 'I0005'-->
<!--                   LEFT JOIN RESULT_DETAIL RSBP  ON R.RESULT_SEQ = RSBP.RESULT_SEQ-->
<!--                                                AND R.ITEM_ID = IBP.ITEM_ID-->
<!--                                                AND RSBP.RESULT_TYPE = '03'-->
<!--                   LEFT JOIN RESULT_DETAIL RDBP  ON R.RESULT_SEQ = RDBP.RESULT_SEQ-->
<!--                                                AND R.ITEM_ID = IBP.ITEM_ID-->
<!--                                                AND RDBP.RESULT_TYPE = '02'-->
<!--                   /* 심박수-맥박 */-->
<!--                   INNER JOIN ITEM         IPR   ON IPR.ITEM_ID = 'I0002'-->
<!--                   LEFT JOIN RESULT_DETAIL RPR   ON R.RESULT_SEQ = RPR.RESULT_SEQ-->
<!--                                                AND R.ITEM_ID = IPR.ITEM_ID-->
<!--                   /* 체온 */-->
<!--                   INNER JOIN ITEM         IBT   ON IBT.ITEM_ID = 'I0001'-->
<!--                   LEFT JOIN RESULT_DETAIL RBT   ON R.RESULT_SEQ = RBT.RESULT_SEQ-->
<!--                                                AND R.ITEM_ID = IBT.ITEM_ID-->
<!--                   /* 걸음수-호흡 */-->
<!--                   INNER JOIN ITEM         IRR   ON IRR.ITEM_ID = 'I0004'-->
<!--                   LEFT JOIN RESULT_DETAIL RRR1  ON R.RESULT_SEQ = RRR1.RESULT_SEQ-->
<!--                                                AND R.ITEM_ID = IRR.ITEM_ID-->
<!--                                                AND RRR1.RESULT_TYPE = '04'-->
<!--                   LEFT JOIN RESULT_DETAIL RRR2  ON R.RESULT_SEQ = RRR2.RESULT_SEQ-->
<!--                                                AND R.ITEM_ID = IRR.ITEM_ID-->
<!--                                                AND RRR2.RESULT_TYPE = '05'-->
<!--                   /* 산소포화도 */-->
<!--                   LEFT JOIN ITEM          ISP   ON ISP.ITEM_ID = 'I0003'-->
<!--                   LEFT JOIN RESULT_DETAIL RSP   ON R.RESULT_SEQ = RSP.RESULT_SEQ-->
<!--                                                AND R.ITEM_ID = ISP.ITEM_ID-->
<!--             WHERE R.ADMISSION_ID = #{admissionId}-->
<!--               AND R.RESULT_DATE BETWEEN #{resultFromDt} AND #{resultToDt})-->
<!--        SELECT A.RESULT_DT-->
<!--             , MAX(CASE WHEN A.ITEM_ID = 'I0005'-->
<!--                             THEN CONCAT(A.SBP, '/', A.DBP)-->
<!--                        ELSE NULL END) AS BP-->
<!--             , MAX(CASE WHEN A.ITEM_ID = 'I0005'-->
<!--                             THEN A.SBP-->
<!--                        ELSE NULL END) AS SBP-->
<!--             , MAX(CASE WHEN A.ITEM_ID = 'I0005'-->
<!--                             THEN A.DBP-->
<!--                        ELSE NULL END) AS DBP-->
<!--             , MAX(CASE WHEN A.ITEM_ID = 'I0005'-->
<!--                             THEN A.BP_RISK_YN-->
<!--                        ELSE 'N' END) AS BP_RISK_YN-->
<!--             , MAX(CASE WHEN A.ITEM_ID = 'I0002'-->
<!--                             THEN A.PR-->
<!--                        ELSE NULL END) AS PR-->
<!--             , MAX(CASE WHEN A.ITEM_ID = 'I0002'-->
<!--                             THEN A.PR_RISK_YN-->
<!--                        ELSE 'N' END) AS PR_RISK_YN-->
<!--             , MAX(CASE WHEN A.ITEM_ID = 'I0001'-->
<!--                             THEN A.BT-->
<!--                        ELSE NULL END) AS BT-->
<!--             , MAX(CASE WHEN A.ITEM_ID = 'I0001'-->
<!--                             THEN A.BT_RISK_YN-->
<!--                        ELSE 'N' END) AS BT_RISK_YN-->
<!--             , MAX(CASE WHEN A.ITEM_ID = 'I0004'-->
<!--                             THEN A.RR1-->
<!--                        ELSE NULL END) AS RR-->
<!--             , MAX(CASE WHEN A.ITEM_ID = 'I0004'-->
<!--                             THEN A.RR_RISK_YN-->
<!--                        ELSE 'N' END) AS RR_RISK_YN-->
<!--             , MAX(CASE WHEN A.ITEM_ID = 'I0003'-->
<!--                             THEN A.SPO2-->
<!--                        ELSE NULL END) AS SPO2-->
<!--             , MAX(CASE WHEN A.ITEM_ID = 'I0003'-->
<!--                             THEN A.SPO2_RISK_YN-->
<!--                        ELSE 'N' END) AS SPO2_RISK_YN-->
<!--         FROM TAB_RESULT A-->
<!--        GROUP BY A.RESULT_DT-->
<!--        ORDER BY A.RESULT_DT DESC-->
<!--    ]]>-->

<!--&lt;!&ndash;	<![CDATA[&ndash;&gt;-->
<!--&lt;!&ndash;	    &#45;&#45; 환자 상세 대쉬보드 측정결과 데이터 조회&ndash;&gt;-->
<!--&lt;!&ndash;	    &#45;&#45; selectPatientDetailDashboardResultList	    &ndash;&gt;-->
<!--&lt;!&ndash;		/* TODO::V/S ITEM_CD 확정 후 쿼리 수정 필요, SBP,DBP 항목 확인 */&ndash;&gt;-->
<!--&lt;!&ndash;		WITH TAB AS&ndash;&gt;-->
<!--&lt;!&ndash;		(&ndash;&gt;-->
<!--&lt;!&ndash;		SELECT A.RESULT_DT &ndash;&gt;-->
<!--&lt;!&ndash;		     , MAX(CASE WHEN A.ITEM_ID = 'I0025' THEN RESULT ELSE NULL END) AS BP &ndash;&gt;-->
<!--&lt;!&ndash;		     , MAX(CASE WHEN A.ITEM_ID = 'I0026' THEN RESULT ELSE NULL END) AS PR&ndash;&gt;-->
<!--&lt;!&ndash;		     , MAX(CASE WHEN A.ITEM_ID = 'I0027' THEN RESULT ELSE NULL END) AS BT&ndash;&gt;-->
<!--&lt;!&ndash;		     , MAX(CASE WHEN A.ITEM_ID = 'I0028' THEN RESULT ELSE NULL END) AS RR&ndash;&gt;-->
<!--&lt;!&ndash;		     , MAX(CASE WHEN A.ITEM_ID = 'I0029' THEN RESULT ELSE NULL END) AS SPO2&ndash;&gt;-->
<!--&lt;!&ndash;		  FROM RESULT A &ndash;&gt;-->
<!--&lt;!&ndash;		 WHERE A.ADMISSION_ID = #{admissionId}&ndash;&gt;-->
<!--&lt;!&ndash;		    AND A.RESULT_DT BETWEEN DATE_FORMAT(#{resultFromDt}, '%Y-%m-%d') AND DATE_FORMAT(#{resultToDt}, '%Y-%m-%d')&ndash;&gt;-->
<!--&lt;!&ndash;		   AND A.ITEM_ID IN ('I0025','I0026','I0027','I0028','I0029')  &ndash;&gt;-->
<!--&lt;!&ndash;		 GROUP&ndash;&gt;-->
<!--&lt;!&ndash;		    BY A.RESULT_DT  &ndash;&gt;-->
<!--&lt;!&ndash;		 ORDER &ndash;&gt;-->
<!--&lt;!&ndash;		    BY A.RESULT_DT DESC&ndash;&gt;-->
<!--&lt;!&ndash;		)&ndash;&gt;-->
<!--&lt;!&ndash;		SELECT RESULT_DT                         &#45;&#45; 측정일시&ndash;&gt;-->
<!--&lt;!&ndash;			 , BP        &#45;&#45; 혈압&ndash;&gt;-->
<!--&lt;!&ndash;			 , CASE&ndash;&gt;-->
<!--&lt;!&ndash;				   WHEN INSTR(BP, '/') BETWEEN 1 AND LENGTH(BP)&ndash;&gt;-->
<!--&lt;!&ndash;					   THEN SUBSTRING_INDEX(BP, '/', 1)&ndash;&gt;-->
<!--&lt;!&ndash;			END AS SBP   &#45;&#45; SBP&ndash;&gt;-->
<!--&lt;!&ndash;			 , CASE&ndash;&gt;-->
<!--&lt;!&ndash;				   WHEN SUBSTRING_INDEX(BP, '/', 1) > 130&ndash;&gt;-->
<!--&lt;!&ndash;					   THEN 'Y'&ndash;&gt;-->
<!--&lt;!&ndash;				   ELSE 'N'&ndash;&gt;-->
<!--&lt;!&ndash;			END AS BP_RISK_YN&ndash;&gt;-->
<!--&lt;!&ndash;			 , CASE&ndash;&gt;-->
<!--&lt;!&ndash;				   WHEN INSTR(BP, '/') BETWEEN 1 AND LENGTH(BP)&ndash;&gt;-->
<!--&lt;!&ndash;					   THEN SUBSTRING_INDEX(BP, '/', -1)&ndash;&gt;-->
<!--&lt;!&ndash;				   ELSE NULL&ndash;&gt;-->
<!--&lt;!&ndash;			END AS DBP   &#45;&#45; DBP&ndash;&gt;-->
<!--&lt;!&ndash;			 , PR        &#45;&#45; 맥박&ndash;&gt;-->
<!--&lt;!&ndash;			 , CASE&ndash;&gt;-->
<!--&lt;!&ndash;				   WHEN PR >= 135&ndash;&gt;-->
<!--&lt;!&ndash;					   THEN 'Y'&ndash;&gt;-->
<!--&lt;!&ndash;				   ELSE 'N'&ndash;&gt;-->
<!--&lt;!&ndash;			END AS PR_RISK_YN&ndash;&gt;-->
<!--&lt;!&ndash;			 , BT        &#45;&#45; 체온&ndash;&gt;-->
<!--&lt;!&ndash;			 , CASE&ndash;&gt;-->
<!--&lt;!&ndash;				   WHEN BT >= 37.5&ndash;&gt;-->
<!--&lt;!&ndash;					   THEN 'Y'&ndash;&gt;-->
<!--&lt;!&ndash;				   ELSE 'N'&ndash;&gt;-->
<!--&lt;!&ndash;			END AS BT_RISK_YN&ndash;&gt;-->
<!--&lt;!&ndash;			 , RR        &#45;&#45; 호흡&ndash;&gt;-->
<!--&lt;!&ndash;			 , CASE&ndash;&gt;-->
<!--&lt;!&ndash;				   WHEN RR >= 30&ndash;&gt;-->
<!--&lt;!&ndash;					   THEN 'Y'&ndash;&gt;-->
<!--&lt;!&ndash;				   ELSE 'N'&ndash;&gt;-->
<!--&lt;!&ndash;			END AS RR_RISK_YN&ndash;&gt;-->
<!--&lt;!&ndash;			 , SPO2      &#45;&#45; 산소포화도&ndash;&gt;-->
<!--&lt;!&ndash;			 , CASE&ndash;&gt;-->
<!--&lt;!&ndash;				   WHEN SPO2 <= 90&ndash;&gt;-->
<!--&lt;!&ndash;					   THEN 'Y'&ndash;&gt;-->
<!--&lt;!&ndash;				   ELSE 'N'&ndash;&gt;-->
<!--&lt;!&ndash;			END AS SPO2_RISK_YN&ndash;&gt;-->
<!--&lt;!&ndash;		  FROM TAB&ndash;&gt;-->

<!--&lt;!&ndash;	]]>&ndash;&gt;-->
<!--	</select>-->

<!--	&lt;!&ndash; SELECT 측정 ITEM 정보 By ItemId&ndash;&gt;-->
<!--	<select id="selectItemByItemId" parameterType="String" resultType="kr.co.hconnect.vo.ItemVO">-->
<!--	<![CDATA[-->
<!--		&#45;&#45; TODO 측정ITEM 선택방법 변경될 수 있음-->
<!--		SELECT ITEM_ID &#45;&#45; 측정 ITEM ID-->
<!--		     , ITEM_NM &#45;&#45; 측정 ITEM 명-->
<!--			 , UNIT    &#45;&#45; 측정 UNIT-->
<!--		FROM ITEM-->
<!--		    WHERE ITEM_ID  =   #{centerId}-->
<!--	]]>-->
<!--	</select>-->

</mapper>
