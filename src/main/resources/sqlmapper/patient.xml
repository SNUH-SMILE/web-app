<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="kr.co.hconnect.sqlmapper">

    <!-- 환자정보 조회-로그인ID 기준 -->
	<select id="selectPatientByLoginId" parameterType="String" resultType="kr.co.hconnect.domain.Patient">
	<![CDATA[
		SELECT PATIENT_ID -- 환자ID
             , LOGIN_ID   -- 로그인ID
             , PASSWORD   -- 비밀번호
             , PATIENT_NM -- 성명
             , SSN        -- 주민번호
             , BIRTH_DATE -- 생년월일
             , SEX        -- 성별
             , CELL_PHONE -- 휴대폰
             , ZIP_CODE   -- 우편번호
             , ADDRESS1   -- 주소
             , ADDRESS2   -- 상세주소
          FROM PATIENT
         WHERE LOGIN_ID = #{loginId}
	]]>
	</select>

	<!-- 환자정보 조회-주민번호(암호화) 기준 -->
	<select id="selectPatientBySsn" parameterType="String" resultType="kr.co.hconnect.domain.Patient">
	<![CDATA[
		SELECT PATIENT_ID		-- 환자ID
			 , LOGIN_ID         -- 로그인ID
			 , PASSWORD         -- 비밀번호
			 , PATIENT_NM       -- 성명
			 , SSN              -- 주민번호
			 , BIRTH_DATE       -- 생년월일
			 , SEX              -- 성별
			 , CELL_PHONE       -- 휴대폰
			 , ZIP_CODE         -- 우편번호
			 , ADDRESS1         -- 주소
			 , ADDRESS2         -- 상세주소
		  FROM PATIENT
		 WHERE SSN = #{ssn}
	]]>
	</select>

	<!-- 환자정보 조회-아이디 검색 조건 정보 기준 -->
	<select id="selectPatientBySearchLoginIdInfo" parameterType="kr.co.hconnect.domain.SearchLoginIdInfo" resultType="kr.co.hconnect.domain.Patient">
	<![CDATA[
		SELECT PATIENT_ID		-- 환자ID
			 , LOGIN_ID         -- 로그인ID
			 , PASSWORD         -- 비밀번호
			 , PATIENT_NM       -- 성명
			 , SSN              -- 주민번호
			 , BIRTH_DATE       -- 생년월일
			 , SEX              -- 성별
			 , CELL_PHONE       -- 휴대폰
			 , ZIP_CODE         -- 우편번호
			 , ADDRESS1         -- 주소
			 , ADDRESS2         -- 상세주소
		  FROM PATIENT
		 WHERE PATIENT_NM = #{patientNm}
           AND CELL_PHONE = #{cellPhone}
	]]>
	</select>

	<!-- 환자정보 조회-개인정보 확인 검색 조건 기준 -->
	<select id="selectPatientBySearchExistLoginInfo" parameterType="kr.co.hconnect.domain.SearchExistLoginInfo" resultType="kr.co.hconnect.domain.Patient">
	<![CDATA[
		SELECT PATIENT_ID		-- 환자ID
			 , LOGIN_ID         -- 로그인ID
			 , PASSWORD         -- 비밀번호
			 , PATIENT_NM       -- 성명
			 , SSN              -- 주민번호
			 , BIRTH_DATE       -- 생년월일
			 , SEX              -- 성별
			 , CELL_PHONE       -- 휴대폰
			 , ZIP_CODE         -- 우편번호
			 , ADDRESS1         -- 주소
			 , ADDRESS2         -- 상세주소
	      FROM PATIENT
		 WHERE LOGIN_ID = #{loginId}
		   AND PATIENT_NM = #{patientNm}
		   AND CELL_PHONE = #{cellPhone}
	]]>
	</select>

	<!-- 환자 추가 정보 업데이트 -->
	<update id="addPatientInfo" parameterType="kr.co.hconnect.domain.Patient">
	<![CDATA[
		UPDATE PATIENT
		   SET LOGIN_ID   = #{loginId}
		     , PASSWORD   = #{password}
		     , PATIENT_NM = #{patientNm}
		     , BIRTH_DATE = #{birthDate}
		     , SEX        = #{sex}
		     , CELL_PHONE = #{cellPhone}
		     , ZIP_CODE   = #{zipCode}
		     , ADDRESS1   = #{address1}
		     , ADDRESS2   = #{address2}
			 , UPD_DT     = NOW()
		 WHERE PATIENT_ID = #{patientId};

	]]>
	</update>

    <!-- 환자 비밀번호 변경-LoginId 기준 -->
    <update id="updatePatientPasswordByLoginId" parameterType="kr.co.hconnect.domain.LoginInfo">
	<![CDATA[
        UPDATE PATIENT
        SET PASSWORD = #{password}
          , UPD_DT   = NOW()
        WHERE LOGIN_ID = #{loginId}
        ]]>
	</update>

    <!-- 본인인증 내역 확인 -->
    <select id="selectIdentityInfo" parameterType="String" resultType="kr.co.hconnect.domain.IdentityResult">
    <![CDATA[
        SELECT IFNULL(B.QANTN_DIV, '0') AS QUARANTINE_DIV
             , CASE
                   WHEN IFNULL(A.LOGIN_ID, '') <> ''
                       THEN 'Y'
                   ELSE 'N'
            END                         AS REGISTER_YN
        FROM PATIENT A
                 LEFT OUTER JOIN admission B ON A.PATIENT_ID = B.PATIENT_ID
            AND B.ADMISSION_DATE <= NOW()
            AND B.DSCHGE_DATE IS NULL
            AND B.DEL_YN = 'N'
        WHERE A.SSN = #{ssn}
        ]]>
    </select>

    <!-- 환자정보 생성 -->
    <insert id="insertPatient" parameterType="kr.co.hconnect.vo.PatientVO">
	<![CDATA[
        INSERT
        INTO PATIENT
        (      PATIENT_ID
        ,      NAME
        ,      BIRTH_DATE
        ,      CONTACT
		     , SEX
		     , REG_ID
		     , UPD_ID
		     )
		VALUES
		     ( #{patientId}
		     , #{name}
		     , #{birthDate}
		     , #{contact}
		     , #{sex}
		     , #{regId}
		     , #{updId}
		     )
	]]>
	</insert>
	
	<!-- 환자정보 수정 -->
	<update id="updatePatient" parameterType="kr.co.hconnect.vo.PatientVO">
	<![CDATA[
		-- 환자정보 수정 
		-- updatePatient
		UPDATE PATIENT 
		   SET NAME       = #{name} 
		     , BIRTH_DATE = #{birthDate}
		     , CONTACT    = #{contact}
		     , SEX        = #{sex}
		     , UPD_ID     = #{updId}
		     , UPD_DT     = current_timestamp()
		 WHERE PATIENT_ID = #{patientId}
	]]> 
	</update>

</mapper>
